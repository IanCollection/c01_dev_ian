import time

from Agent.client_manager import qwen_client, silicon_client
import json
import os
from openai import OpenAI
import time
import concurrent.futures
from datetime import datetime
from typing import List, Dict, Any, Tuple

# 假设这些客户端已经在其他地方初始化
from Agent.client_manager import qwen_client, silicon_client
from Agent.tool_agents import json_format_agent

client = silicon_client
qwen_client = qwen_client


def title_cics(title):
    #对title进行拆分，拆分后的title 进行语义增强，然后进行合并。
    #最后返回合并后的title 打上cics 多级别标签。然后根据 cics 标签表返回所有标签结构。
    return title

def title_semantic_enhancement_agent(title):
    """
    对研报标题进行语义增强，深入分析标题含义并扩展相关内容，优化后的结果可用于政策ES搜索
    
    Args:
        title (str): 用户输入的研报标题
    
    Returns:
        dict: 包含语义增强结果的字典，包括扩展标题、关键词列表等，适合ES搜索使用
    """
    prompt = f"""
    请对以下研报标题进行深度语义增强分析，结果将用于政策文档的精准检索：
    
    标题: {title}
    
    请从以下几个方面进行分析：
    1. 标题核心概念：分析标题中的核心概念和术语，提取可用于检索的关键词
    2. 行业背景：相关行业的发展现状和趋势，提取行业特定术语
    3. 技术维度：涉及的关键技术和创新点，提取技术专有名词
    4. 市场维度：市场规模、竞争格局和发展前景，提取市场相关术语
    5. 政策环境：相关政策法规和监管趋势，提取政策关键词和文件名称
    6. 扩展标题：在保持原意的基础上，提供更全面的标题表述
    
    请以JSON格式返回分析结果，包含以下字段：
    - expanded_title: 扩展后的标题，更全面且包含更多检索信息
    - search_keywords: 用于检索的关键词列表，按重要性排序
    - policy_terms: 政策相关术语和文件名称列表
    - industry_terms: 行业特定术语列表
    - technical_terms: 技术专有名词列表
    
    所有关键词应当简洁、精准，适合用于ES全文检索。请直接输出有效的JSON格式，不要包含任何代码块标记或额外说明。
    """
    
    response = qwen_client.chat.completions.create(
        model="qwen-max-latest",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.6,
        response_format={"type": "json_object"},

    )
    
    content = response.choices[0].message.content
    try:
        json_content = json.loads(content)
        # 计算成本
        input_cost = (response.usage.prompt_tokens / 1000) * 0.0024
        output_cost = (response.usage.completion_tokens / 1000) * 0.0096
        cost = input_cost + output_cost
        return json_content, cost
    except json.JSONDecodeError:
        # 如果解析失败，使用format_agent进行格式化
        formatted_json = json_format_agent(content)
        # 计算成本
        input_cost = (response.usage.prompt_tokens / 1000) * 0.0024
        output_cost = (response.usage.completion_tokens / 1000) * 0.0096
        cost = input_cost + output_cost
        return formatted_json, cost

def policy_summary_agent(policy_content: str) -> str:
    """
    对政策内容进行简洁概括总结
    
    Args:
        policy_content (str): 需要概括的政策文本内容
    
    Returns:
        str: 2-3句话的政策内容概括
    """
    prompt = f"""
    请对以下政策文件内容进行简洁概括，用2-3句话总结其核心内容和主要目标：
    
    {policy_content}
    
    要求：
    1. 提炼政策的核心要点和主要目标
    2. 概括政策的关键措施或规定
    3. 总结限制在2-3句话内
    4. 使用客观、准确的语言
    5. 直接输出概括内容，不要包含任何额外说明
    6. 以JSON格式返回，格式为：{{"summary": "政策概括内容"}}
    """
    # End of Selection
    max_retries = 3
    retry_count = 0
    
    while retry_count < max_retries:
        try:
            # 使用 qwen-turbo 模型进行概括
            response = qwen_client.chat.completions.create(
                model="qwen-turbo",
                messages=[{"role": "user", "content": prompt}],
                temperature=0.3,
                max_tokens=300,
                response_format={"type": "json_object"},

            )
            
            summary = response.choices[0].message.content.strip()
            
            # 计算成本
            input_cost = (response.usage.prompt_tokens / 1000) * 0.0003
            output_cost = (response.usage.completion_tokens / 1000) * 0.0006
            cost = input_cost + output_cost
            
            
            return summary, cost
            
        except Exception as e:
            retry_count += 1
            if retry_count >= max_retries:
                print(f"政策概括生成出错，已重试{max_retries}次: {e}")
                return "无法生成政策概括。", 0
            print(f"政策概括生成出错，正在进行第{retry_count}次重试: {e}")
            time.sleep(0.1)  # 重试前等待1秒


if __name__ == "__main__":
    content = """
'广东省发展改革委 广东省科技厅 广东省工业和信息化厅关于印发广东省培育半导体及集成电路战略性新兴产业集群行动计划（2021-2025年）的通知\n            粤发改产业〔2020〕338号各地级以上市人民政府，省政府各部门、各直属机构：\u3000\u3000《广东省培育半导体及集成电路战略性新兴产业集群行动计划（2021-2025年）》已经省人民政府同意。现印发给你们，请结合本地本部门工作实际，认真组织实施。实施过程中遇到的重大问题，请径向省发展改革委反映。广东省发展改革委 广东省科技厅 广东省工业和信息化厅2020年9月25日广东省培育半导体及集成电路战略性新兴产业集群行动计划（2021-2025年）\u3000\u3000为贯彻省委、省政府关于推进制造强省建设的工作部署，加快培育半导体及集成电路战略性新兴产业集群，促进产业迈向全球价值链高端，依据《广东省人民政府关于培育发展战略性支柱产业集群和战略性新兴产业集群的意见》（粤府函[2020]82号）等文件精神，制定本行动计划。\u3000\u3000一、总体情况\u3000\u3000（一）发展现状。半导体及集成电路产业主要包括半导体器件的设计、制造、封装测试，以及相关原材料、辅助材料、装备等。广东是我国信息产业第一大省，在消费电子、通信、人工智能、汽车电子等领域拥有国内最大的半导体及集成电路应用市场，集成电路进口金额占全国的40%左右。2019年集成电路产业主营业务收入超过1200亿元，其中集成电路设计业营业收入超过1000亿元。拥有广州和深圳两个国家级集成电路设计产业化基地，基本形成以广州、深圳、珠海为核心，带动佛山、东莞、中山、惠州等地协同发展的产业格局。\u3000\u3000（二）问题与挑战。存在问题：一是创新能力不强，创新要素投入不足，关键核心技术研发能力薄弱。二是设计企业普遍规模偏小，高水平设计能力不足。三是制造环节短板明显，实现规模化量产的12英寸晶圆线仅1条。四是高校人才培养严重短缺，微电子专业在校生不足2000人，人才引进难度越来越大，人才供求矛盾突出。五是对外依存度高，产业链供应链安全可控性亟待提升。在当前国际技术封锁及国内区域竞争加剧的背景下，迫切需要加快补齐产业链短板，提升产业链供应链稳定性安全性，为推动制造业高质量发展提供有力支撑。\u3000\u3000（三）优势和机遇。广东设计业营业收入全国第一，终端应用市场庞大，市场机制比较成熟。目前，国家持续加大对集成电路产业的支持力度，产业发展环境不断完善，5G、人工智能、智能网联汽车、工业互联网、超高清视频等产业对半导体及集成电路的需求快速增长，这些都为广东发展半导体及集成电路产业提供了良好的发展机遇。\u3000\u3000二、工作目标\u3000\u3000（一）规模快速增长。到2025年，年主营业务收入突破4000亿元，年均增长超过20%。其中，集成电路设计业超2000亿元，形成3家以上销售收入超100亿元和一批销售收入超10亿元的设计企业；集成电路制造业超1000亿元，建成较大规模特色工艺制程生产线。先进封测比例显著提升，部分化合物半导体材料、器件生产能力国内领先，特种装备及零部件发展初具规模。\u3000\u3000（二）创新能力明显提升。到2025年，设计行业骨干企业研发投入强度超过20%，全行业研发投入强度超过5%，发明专利密集度和质量位居全国前列。EDA（电子设计自动化）软件具备国产替代能力，集成电路设计水平进入国际先进行列。形成较为完善的人才引进和培养体系，微电子等相关专业招生规模争取年均增长20%以上。新组建15个以上半导体及集成电路领域的省级重点实验室、工程实验室等，建成5个以上公共技术服务平台。\u3000\u3000（三）布局更加完善。到2025年，一批龙头企业国际话语权显著提升，集聚一批创新能力强的“独角兽”企业、细分领域“单项冠军”和“专精特新”企业，产业链供应链国产化水平进一步提升。广州、深圳、珠海的辐射带动作用进一步增强，形成穗莞深惠和广佛中珠两大发展带，珠三角地区建设成为具有国际影响力的半导体及集成电路产业集聚区。\u3000\u3000三、重点任务\u3000\u3000（一）推动产业集聚发展。以广州、深圳、珠海为核心区域，积极推进特色制程和先进制程集成电路制造，加快培育化合物半导体，在晶圆制造工艺、FPGA、DSP、数模混合芯片、模拟信号链芯片、射频前端、EDA工具、关键IP核等领域实现突破，打造涵盖设计、制造、封测等环节的全产业链。以深圳、汕头、梅州、肇庆、潮州为依托建设新型电子元器件产业集聚区，广深珠莞等多地联动发展化合物半导体产业。佛山、惠州、东莞、中山、江门、汕尾等城市依据各自产业基础，在封装测试、半导体材料、特种装备及零部件、电子化学品等领域，积极培育发展产业龙头企业，推动建设半导体及集成电路产业园区，形成与广深珠联动发展格局。（省发展改革委、科技厅、工业和信息化厅及有关市政府按职责分工负责）\u3000\u3000（二）突破产业关键核心技术。持续推进重点领域研发计划，围绕芯片设计与架构、特色工艺制程、先进封装测试工艺、化合物半导体、EDA工具、特种装备及零部件等领域开展关键核心技术攻关。密切跟进碳基芯片技术发展。支持提前部署相关前沿技术、颠覆性技术。对于风险较高、不确定因素较多的关键领域科技攻关，适当支持探索多种技术路线，加强技术储备。加强用于数据中心和服务器的高性能CPU、GPU、FPGA等高端通用芯片技术研发，加大5G基带芯片、光通信芯片、射频芯片、AI芯片、智能终端芯片、MEMS传感器芯片、物联网芯片、车规级SoC汽车电子芯片、超高清视频芯片等专用芯片的关键技术研发和制造，提升核心芯片自主化水平。全面执行国家研发费用税前加计扣除75%政策，对研发费用占销售收入不低于5%的企业，鼓励各市对其增按不超过25%研发费用税前加计扣除标准给予奖补，省可根据各市财力状况在此基础上按1：1给予事后再奖励。（省科技厅、发展改革委、工业和信息化厅以及有关市政府按职责分工负责）\u3000\u3000（三）打造公共服务平台。加快发展半导体及集成电路公共服务平台，为中小微企业提供EDA工具、芯片架构、SoC（系统级芯片）设计、MPW（多项目晶圆加工）、快速封测、部件及终端产品模拟、测试验证等服务。支持高校、科研机构、检测验证机构以及有研发能力的大型企业建设产品质量测评、环境适应性评价、安全可靠性认证等方面的公共服务平台。推动混合集成、异构集成技术研发与产业化，支持建设混合集成芯片创新平台（先导线和中试线）。在化合物半导体等领域布局国家级创新平台。省区域协调发展战略专项资金对符合条件的国家级、省级公共服务平台和创新平台建设按不超过其固定资产投资的30%给予支持。（省发展改革委、教育厅、科技厅、工业和信息化厅以及有关市政府按职责分工负责）\u3000\u3000（四）保障产业链供应链安全稳定。支持产业链各环节企业构建战略合作伙伴关系，推动产业集群虚拟垂直整合发展。支持终端应用龙头企业通过数据共享、人才引进和培养、核心技术攻关、产品优先应用等合作方式培育国内高水平供应链，带动芯片设计、原材料、核心电子元器件、设备、关键软件等上下游配套企业协同发展。建立“一对一”服务保障机制，支持龙头企业上下游保供稳链。支持中国（广东）知识产权保护中心拓展和优化专利预审服务，加大快速协同保护力度和广度，缩短专利授权周期。培育高价值专利，建立产业细分领域专利数据库，完善专利预警机制。探索在重点国家和地区建设广东省半导体及集成电路产业知识产权海外维权援助中心或援助服务点。定期运用数据模型，做好集成电路产业进出口情况监测预警分析。（省工业和信息化厅、市场监管局、海关总署广东分署以及有关市政府按职责分工负责）\u3000\u3000（五）构建高水平产业创新体系。依托产业链部署创新链，联合攻关产业关键共性技术，推进成果转化，形成深度融合产学研体系。改革省科技创新战略专项资金项目立项和组织实施方式，试行“广东发布、全国揭榜”的“揭榜挂帅”模式。鼓励相关新型研发机构创新人员聘用和团队组织机制。强化成果导向，建立技术经纪人（经理人）培育和评价机制。探索创新链、产业链与资金链的深度融合机制，通过技术入股、市场化运作等方式推动科研成果快速转化，形成创新利益共同体，激发科研单位和科研人员创新潜力。（省科技厅、教育厅、工业和信息化厅、国资委以及有关市政府按职责分工负责）\u3000\u3000四、重点工程\u3000\u3000（一）底层工具软件培育工程。重点围绕逻辑综合、布图布线、仿真验证等方向，加强数字电路EDA工具软件核心技术攻关。推动模拟或数模混合电路EDA工具软件实现设计全覆盖，打造具有自主知识产权的工具软件。支持开展EDA云上架构和应用AI技术研发。支持TCAD（技术电脑辅助设计软件）、封装EDA工具研发。推动集成电路企业在新产品开发中，应用国家“核高基”（核心电子器件、高端通用芯片及基础软件产品）等专项形成的EDA工具、自主IP等成果。省科技创新战略专项资金持续支持底层算法与架构技术的研发。（省科技厅、工业和信息化厅、科学院按职责分工负责）\u3000\u3000（二）芯片设计领航工程。重点突破边缘计算芯片、储存芯片、处理器等高端通用芯片的设计，大力支持射频、传感器、基带、交换、光通信、显示驱动、RISC-V（基于精简指令集原则的开源指令集架构）、物联网智能硬件、车规级AI、FBAR滤波器等专用芯片的开发设计。大力推动化合物半导体、毫米波、太赫兹等专用芯片设计前沿技术研究。聚焦终端应用需求，建设涵盖芯片设计全流程的公共技术服务平台，强化芯片设计验证过程中急需的MPW、快速封装和测试评价服务。省促进经济高质量发展专项资金对28nm及以下制程、车规级及其他具备较大竞争优势的芯片产品量产前首轮流片费用按不超过30%给予奖补，鼓励各地市出台政策放宽奖补条件、扩大惠及面。大力支持高校、研究机构及企业以创新平台和公共服务平台为载体，联合开展新型芯片的MPW项目。（省科技厅、工业和信息化厅以及有关市政府按职责分工负责）\u3000\u3000（三）制造能力提升工程。大力支持技术先进的IDM（设计、制造及封测一体化）企业和晶圆代工企业布局研发、生产和运营中心，重点推动12英寸晶圆线及8英寸硅基氮化镓晶圆线等项目建设。鼓励探索CIDM（企业共同体IDM）模式。优先发展特色工艺制程芯片制造，重点推进模拟及数模混合芯片生产制造，支持先进制程芯片制造，缩小与国际先进水平的差距。支持广东省大湾区集成电路与系统应用研究院建设，加快FDSOI（全耗尽型绝缘层上硅）核心技术攻关。推动建设MOSFET（金属氧化物半导体场效应晶体管）、IGBT（大功率绝缘栅双极型晶体管）、高端传感器、MEMS（微机电系统）、半导体激光器、光电器件等产线。（省发展改革委、科技厅、工业和信息化厅以及有关市政府按职责分工负责）\u3000\u3000（四）高端封装测试赶超工程。大力引进先进封装测试生产线和技术研发中心，支持现有封测企业开展兼并重组，紧贴市场需求加快封装测试工艺技术升级和产能提升。加快IGBT模块等功率器件封装技术的研发和产业化，重点突破新一代通信与网络超高速光通信核心器件与模块等封测核心技术及装备。大力发展晶圆级、系统级、凸块、倒装、硅通孔、面板级扇出型、三维、真空等先进封装技术，以及脉冲序列测试、MEMS探针、IC集成探针卡等先进晶圆级测试技术。（省发展改革委、科技厅、工业和信息化厅以及有关市政府按职责分工负责）\u3000\u3000（五）化合物半导体抢占工程。大力发展氮化镓、碳化硅、氧化锌、氧化镓、氮化铝、金刚石等半导体材料制造，支持氮化镓、碳化硅、砷化镓、磷化铟等化合物半导体器件和模块的研发制造。大力培育引进技术领先的化合物半导体IDM企业，支持建设射频、传感器、电力电子等器件生产线，形成配套材料和封装能力。引导通信设备、新能源汽车、电源系统等领域企业推广试用化合物半导体产品，提升系统和整机产品性能。（省科技厅、发展改革委、工业和信息化厅以及有关市政府按职责分工负责）\u3000\u3000（六）材料及关键电子元器件补链工程。大力发展电子级多晶硅及硅片制造，加快氟聚酰亚胺、光刻胶、高纯度化学试剂、电子气体、碳基、高密度封装基板等材料研发生产。大力支持纳米级陶瓷粉体、微波陶瓷粉体、功能性金属粉体、贱金属浆料等元器件关键材料和功能性基质材料的研发及产业化。推动电子元器件企业与整机厂联合开展核心技术攻关，支持建设高端片式电容器、电感器、电阻器等元器件以及高端印制电路板生产线，提升国产化水平。（省发展改革委、科技厅、工业和信息化厅、国资委以及有关市政府按职责分工负责）\u3000\u3000（七）特种装备及零部件配套工程。重点围绕光学和电子束光刻机关键部件和系统集成开展持续研发和技术攻关。积极推进缺陷检测设备、激光加工设备、半导体芯片巨量组装设备等整机设备生产，支持高精密陶瓷零部件、射频电源、高速高清投影镜头、仪器仪表等设备关键零部件研发。对产业链企业应用国产装备给予首台（套）装机补贴，大力引进国内外沉积设备、刻蚀设备、等离子清洗机、薄膜制备设备等领域的龙头企业。（省科技厅、发展改革委、工业和信息化厅、商务厅以及有关市政府按职责分工负责）\u3000\u3000（八）人才集聚工程。组织开展集成电路产业人才开发路线图研究，省相关高层次人才引进计划将集成电路产业列入重点支持方向，加快从全球靶向引进高端领军人才、创新团队和管理团队。引导高校围绕产业需求调整学科专业设置，推动有条件的高校建设国家示范性微电子学院。扩大微电子专业师资规模及招生规模，省属高校可自行确定微电子专业招生计划。推动国产软件设备进校园。开展集成电路产教融合试点，鼓励企业联合职业院校及高校培养技术能手。省基础与应用基础研究基金安排一定比例的资金专项资助未获得省部级以上科研项目资助的博士和博士后。兼顾高端领军人才、中坚骨干力量、技术能手等多层次人才需求，适当放宽人才认定标准。鼓励各市在户籍、个税奖励（返还）、住房保障、医疗保障、子女就学、创新创业等方面对集成电路人才给予优先支持。（省委人才办、省教育厅、发展改革委、科技厅、人力资源社会保障厅以及有关市政府按职责分工负责）\u3000\u3000五、保障措施\u3000\u3000（一）加强组织领导。广东省半导体及集成电路产业发展领导小组统筹推进全省半导体及集成电路产业发展，整合各方资源，协调解决重大问题。各有关地市及省相关部门，明确工作职责，加大政策支持力度，形成省市联动工作合力。成立广东省半导体及集成电路产业发展专家咨询委员会，对产业发展的重大问题和政策措施开展调查研究，进行论证评估，提供咨询建议。（省半导体及集成电路产业发展领导小组成员单位及有关市政府按职责分工负责）\u3000\u3000（二）加大财政金融支持力度。省产业发展基金、创新创业基金以及相关专项资金要加大对半导体及集成电路产业的支持力度、形成合力。省科技创新战略专项资金每年投入不低于10亿元用于支持集成电路领域技术创新。对于半导体及集成电路领域的基础研究和应用基础研究、突破关键核心技术或解决“卡脖子”问题的重大研发项目，省级财政给予持续支持。省半导体及集成电路产业投资基金重点投向具有重要带动作用的设计、制造、封测等项目。积极争取国家集成电路产业投资基金、政策性银行支持半导体及集成电路重大项目。鼓励各类创业投资和股权投资基金投资半导体及集成电路产业。优先支持金融机构推出符合集成电路设计等轻资产企业融资需求的信贷创新产品。（省发展改革委、科技厅、财政厅、地方金融监管局以及有关市政府按职责分工负责）\u3000\u3000（三）支持重大项目建设。半导体及集成电路产业的重大项目优先列入省重点建设项目计划，对晶圆制造项目需要新增建设用地的由省统筹安排用地指标。积极吸引国内外半导体及集成电路龙头企业在广东设立总部、投资建设重大项目，建立重大项目投资决策和快速落地联动响应机制。对投资额较大的制造、设计、EDA软件、封测、装备及零部件等领域项目，以及产业带动作用明显的国家级公共服务平台、创新平台，可按照“一事一议”的方式予以支持。（省发展改革委、科技厅、工业和信息化厅、财政厅、自然资源厅、商务厅以及有关市政府按职责分工负责）\n            \n            \n        """
    print(policy_summary_agent(content))